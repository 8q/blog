<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.60.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Unity(UniRx)で蚊を倒すゲームを作った話 &middot; さやかちゃんドットネット</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://blog.sayakachan.net/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://blog.sayakachan.net/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://blog.sayakachan.net/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://blog.sayakachan.net/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:image" content="https://blog.sayakachan.net/images/twitter_card_image.jpg"/>
  <meta name="twitter:title" content="Unity(UniRx)で蚊を倒すゲームを作った話"/>
  <meta name="twitter:description" content="
     


遊びでUnityで蚊を倒すゲームを作ってみました。大学の学祭のときにでもみんなに遊んでもらおうと画策してます。ゲームの紹介と技術的なことを書きます。"/>
</head>

  <body class="theme-base-0a ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://blog.sayakachan.net/"><h1>blog.sayakachan.net</h1></a>
      <p class="lead">
       とある情報系学生のブログです。 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        
        <li><a href="https://sayakachan.net/"> Portfolio </a></li>
      </ul>
    </nav>

    
    <p>&copy; 2019 sayakachan.net</p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Unity(UniRx)で蚊を倒すゲームを作った話</h1>
  <time datetime=2018-10-02T20:03:46Z class="post-date">Tue, Oct 2, 2018</time>
  <figure>
    <img src="/images/20181002/180131.png"/> 
</figure>

<p>遊びでUnityで蚊を倒すゲームを作ってみました。大学の学祭のときにでもみんなに遊んでもらおうと画策してます。ゲームの紹介と技術的なことを書きます。</p>
<h1 id="heading">遊び方</h1>
<ol>
<li>でてきた蚊をたたいてたおそう！マウスを動かして左クリック！
<figure>
    <img src="/images/20181002/180237.gif"/> 
</figure>
</li>
<li>蚊を倒すとスコアが上がるよ。たくさんたおそう！はずすと命中率が下がってスコアがさがるから気をつけよう。
<figure>
    <img src="/images/20181002/180409.png"/> 
</figure>
</li>
<li>制限時間は90秒！時間内にたくさんの蚊をたおそう！</li>
</ol>
<h1 id="heading1">ゲームの様子</h1>
<p>プレー中の様子を動画にしました。</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/p01EW5hG5ck" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h1 id="heading2">ダウンロード</h1>
<p>GitHubのリリースにWindows・Mac向けのビルド済みファイルを置いてあります。遊んでミテネ。</p>
<p><a href="https://github.com/8q/mosquito-game/releases">8q/mosquito-game/releases</a></p>
<h1 id="heading3">技術的な話</h1>
<h2 id="unirx">UniRxを使って</h2>
<p>せっかくUniRxを覚えたので全面的にUniRxを使って作りました。UniRxのおかげでこれまでのUnityで作ったゲームより圧倒的コンポーネント間の疎結合が実現できたなあと感じています。カーソルを例に考えてみます。
<figure>
    <img src="/images/20181002/180237.gif"/> 
</figure>

今回のゲームではマウスのクリックひとつに</p>
<ol>
<li>「パン」が生成される</li>
<li>蚊に当たると蚊が消える</li>
<li>命中率の再計算を行う</li>
<li>再計算した命中率をUIに反映させる</li>
</ol>
<p>といった複数の処理が発生します。これをUniRxを用いずに愚直に実現するカーソルのビヘイビアを書くと、</p>
<h4 id="badcursorbehaviourcs">BadCursorBehaviour.cs</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BadCursorBehaviour</span> : MonoBehaviour
{
<span style="color:#a6e22e">    [SerializeField]</span>
    <span style="color:#66d9ef">private</span> GameObject pan;
    
    <span style="color:#66d9ef">void</span> Update()
    {
        <span style="color:#66d9ef">if</span>(Input.GetMouseButtonDown(<span style="color:#ae81ff">0</span>))
        {
            <span style="color:#75715e">//1. 「パン」を生成する
</span><span style="color:#75715e"></span>            Instantiate(pan); 
            
            <span style="color:#75715e">//2. 蚊に当たったら蚊を消す処理
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// some code ...
</span><span style="color:#75715e"></span>
            <span style="color:#75715e">//3. 命中率を再計算する処理
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// some code ...
</span><span style="color:#75715e"></span>
            <span style="color:#75715e">//4. 再計算した命中率をUIに反映させる
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// some code ...
</span><span style="color:#75715e"></span>        }
    }
}

</code></pre></div><p>と、こんな感じでカーソルのビヘイビアなのにカーソルに関係ない処理がモリモリ増えていきます。そうすると別クラスに切り出すというのは考えられるのですが、結局カーソルが各クラスのメソッドを呼び出す形になるので、クラス間の依存関係が複雑になってきます。そもそもカーソルがUIの更新を行うのかというところも疑問ですし、カーソルが「パン」のオブジェクトのことを知っておかなければいけないというのも気に食いません。</p>
<p>では、UniRxを使ってイベント駆動にしてみます。カーソルは「クリックをした」というイベントを発行するにとどまり、各処理はそのイベントを観測次第実行するという風にしてみます。</p>
<h4 id="eventmanagercs">EventManager.cs</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventManager</span> : SingletonMonoBehaviour&amp;lt;EventManager&gt;
{
    <span style="color:#66d9ef">public</span> Subject&amp;lt;Unit&gt; MouseClick {<span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">set</span>;} = <span style="color:#66d9ef">new</span> Subject&amp;lt;Unit&gt;();
}

</code></pre></div><h4 id="cursorbehaviourcs">CursorBehaviour.cs</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CursorBehaviour</span> : MonoBehaviour
{
    <span style="color:#66d9ef">private</span> EventManager eventManager;
    
    <span style="color:#66d9ef">void</span> Start()
    {
        eventManager = EventManager.Instance;
    }
    
    <span style="color:#66d9ef">void</span> Update()
    {
        <span style="color:#66d9ef">if</span>(Input.GetMouseButtonDown(<span style="color:#ae81ff">0</span>))
        {
            <span style="color:#75715e">// クリックのイベントを発行
</span><span style="color:#75715e"></span>            eventManager.MouseClick.OnNext(Unit.Default); 
        }
    }
}

</code></pre></div><h4 id="pangeneratercs">PanGenerater.cs</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PanGenerater</span> : MonoBehaviour
{
<span style="color:#a6e22e">    [SerializeField]</span>
    <span style="color:#66d9ef">private</span> GameObject pan;

    <span style="color:#66d9ef">void</span> Start()
    {
        <span style="color:#66d9ef">var</span> eventManager = EventManager.Instance;

        <span style="color:#75715e">// クリックイベントの監視の登録
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Subscribeでイベントが発生したときの動作を登録する。
</span><span style="color:#75715e"></span>        eventManager.MouseClick
            .Subscribe(_ =&gt;
            {
                <span style="color:#75715e">// 「パン」を生成する。
</span><span style="color:#75715e"></span>                Instantiate(pan);
            });
    }
}

</code></pre></div><p>と、このようにEventManagerでイベントを管理して、EventManager経由でイベントを発行・通知するようにしました。するとカーソルがカーソルに関係のない処理を呼び出していたものが、役割に応じた各ビヘイビアに処理ごと切り出すことができました。例では「パン」を生成するコードのみを切り出しましたが、その他処理も同様に切り出せます。クラス間の関係の見通しがよくなったと思いませんか？<strong>最高。</strong></p>
<h1 id="heading4">名前空間の切り分け</h1>
<p>Unityで自動生成されるコードには名前空間が振られない（グローバルな名前空間）ですね。最初は気にせず開発していたのですがこんなことがありました。ゲームシーンでの蚊のビヘイビアとして「MosquitoBehaviour」クラスを作っていました。タイトルシーンでも蚊を動かす必要があったのですが、ゲームシーンでのそれとは動作が違うので新たにビヘイビアを作る必要がありました。クラス名として「MosquitoBehaviour」は既に使われているので「TitleMosquitoBehaviour」か？長くない？そもそもタイトルシーンの方をそういう風に命名するならゲームシーンの方も「GameMosquitoBehaviour」に直す？じゃあカーソルとかのビヘイビアも今後別のシーンで使われることを見越して「GameCursorBehavior」にするのか？とキリがなくなってしまいます。そういうときはシーンごとに名前空間を切り分けてやるとうまくいくんじゃないかと思いました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cs" data-lang="cs"><span style="color:#66d9ef">namespace</span> MosquitoGame.GameScene
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MosquitoBehavoiur</span> : MonoBehaviour
    {
        <span style="color:#75715e">// ゲームシーンの蚊のビヘイビア
</span><span style="color:#75715e"></span>    }
}

</code></pre></div><p>作ったゲームでは以下のようにフォルダ分けして名前空間も分けました。こうすることでゲームシーンでもタイトルシーンでも余計な制約なくクラス名がつけられるようになりました。</p>
<pre><code>Assets/Scripts
├── Editor //拡張エディタ, MosquitoGame.Editor
├── GameScene //ゲームシーン, MosquitoGame.GameScene
├── RankingScene //ランキングシーン, MosquitoGame.RankingScene
├── TitleScene //タイトルシーン, MosquitoGame.TitleScene
└── Utils //シーンを跨いで使う汎用的なスクリプト, MosquitoGame.Utils
</code></pre>
</div>


    </main>

    
  </body>
</html>

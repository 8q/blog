---
title: "zshでパイプ後の標準入力を利用したコマンド置換でハマった。"
date: 2020-06-10T00:00:00+09:00
draft: false
---

コマンド置換(`echo $(command)`など)がbashではうまくいくけどzshでうまくいかないことがあって、なんでだろうなーとしばらく思っていたのが今日解決したので書いておきます。

<!--more-->

# ハマったところ
zshでDocument以下の適当なtxtファイルについてディレクトリ名を表示させようと以下のコマンドを書いたところ、
```
$ find ~/Documents -name "*.txt" | tail -n 1 | dirname "$(cat)"
cat: -: 入力/出力エラーです
.
```
となって上手く行かない。bashだとちゃんと上手くいく。
```
$ bash
$ find ~/Documents -name "*.txt" | tail -n 1 | dirname "$(cat)"
/home/atsushi/Documents/thesis/fig
$ exit
exit
```

簡単にした例として以下のコマンドを試してみる。
```
$ echo test | echo $(cat)
cat: -: 入力/出力エラーです

```
やっぱり上手く行かない。どうもパイプ後の標準入力を利用したコマンド置換が上手くいっていないようだということが分かった。

# 原因
zshとbashだとパイプ越しのコマンド置換での/dev/stdinの指してる先が違うということを知った。これは [@systemctl_ryoto](https://twitter.com/systemctl_ryoto) さんに教えてもらいました(ありがとうございました...!)。

以下の画像は左がzsh、右がbashで試したもの。`readlink -f シンボリックリンク` はシンボリックリンクを再帰的に遡って元のファイル名を表示してくれる。

{{< figure src="/images/20200610/001.png" >}}

- 1段目で今自分が使っているシェルを表示。
- 2段目で `/dev/stdin` の指している先を確認。これは想定どおりでどちらもターミナルからの入力らしきところを指している。
- 3段目でパイプ後の `/dev/stdin` の指している先を確認。これも想定どおりでどちらもパイプ元の出力らしきところを指している。
- 4段目でパイプ後にコマンド置換の中で `/dev/stdin` の指している先を確認。これは想定外でbashはパイプ元の出力を、zshはターミナルからの入力を指してしまっている。

# 対策
```
$ echo test | xargs echo
test
$ echo 2 | xargs -I{} echo 1 {} 3
1 2 3
```
これも [@systemctl_ryoto](https://twitter.com/systemctl_ryoto) さんにアイデアをいただきました。ありがとうございました。